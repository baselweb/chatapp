<!DOCTYPE html>
<html lang="en">
   <head>

    <link rel="stylesheet" href="styles.css">

      <script src="statusBar.js"></script>
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" />
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-68996BGLFE"></script>
      <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());
         gtag('config', 'G-68996BGLFE');
      </script>
      <link rel="manifest" href="manifest.json">
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
      <meta charset="UTF-8">
      <title>Chat Rooms</title>
   </head>
   <body>
      <div class="container">
         <div id="auth">
            <div class="login-register">
               <h2>
                  Rooms
                  <a href="https://adiasta.com/legal" target="_blank" aria-label="Legal Information" id="legal-button">
                     <span class="material-symbols-outlined">help</span>
                  </a>
               </h2>
               <input type="email" id="email" placeholder="Email" />
   <input type="password" id="password" placeholder="Password" />
   <button type="button" id="toggle-password" aria-label="Show Password">
      <span class="material-symbols-outlined">visibility</span>
   </button>
               <div id="auth-error"></div>
               <button id="login">Login</button>
               <button id="register">Register</button>
               <button id="forgot-password">Forgot Password?</button>
            </div>
         </div>
         <div id="room-selection" style="display: none;">
            <div class="login-register">
               <h2>Join / Create</h2>
               <input type="text" id="room-name" placeholder="Enter room name" />
               <button id="join-room">Join Room</button>
               <button id="create-room">Create Room</button>
               <div id="room-error"></div>
            </div>
         </div>
         <div id="chat" style="display: none;">
            <div class="header">
               <h3>Users</h3>
               <div id="header">
                  <div id="typing-indicator" style="display: none;">Someone is typing...</div>
                  <button id="go-back" style="display: none;">
                     <span class="material-symbols-outlined">arrow_back</span>
                  </button>
                  <button id="logout-button">
                     <span class="material-symbols-outlined">logout</span>
                  </button>
               </div>
            </div>
            <div class="messages" id="message-list"></div>
            <div class="input-area">
               <div class="input-container">
                  <input type="text" id="message-input" placeholder="Message" />
                  <button id="send-button" aria-label="Send message">
                     <span class="material-symbols-outlined">send</span>
                  </button>
                  <button id="voice-message-button" aria-label="Record Voice" title="Record Voice Message">
                     <span class="material-symbols-outlined">mic</span>
                  </button>
               </div>
            </div>
         </div>
      </div>
      <script>
         document.getElementById('toggle-password').addEventListener('click', function () {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('span');
            if (passwordInput.type === 'password') {
               passwordInput.type = 'text';
               icon.textContent = 'visibility_off';
            } else {
               passwordInput.type = 'password';
               icon.textContent = 'visibility';
            }
         });
         
      </script>
      <script type="module">
         document.addEventListener("DOMContentLoaded", () => {
           function detectSystemTheme() {
             return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
           }
         
           function applyTheme(theme) {
             const elementsToUpdate = [
               document.body,
               document.querySelector('.header'),
               document.querySelector('#typing-indicator'),
               document.querySelector('#logout-button'),
               document.querySelector('#go-back'),
               document.querySelector('.container'),
               document.querySelector('.messages'),
               document.querySelector('.input-area'),
               ...document.querySelectorAll('.login-register'),
               ...document.querySelectorAll('.message')
             ];
         
             elementsToUpdate.forEach(element => {
               if (element) {
                 if (theme === 'dark') {
                   element.classList.add('dark-theme');
                 } else {
                   element.classList.remove('dark-theme');
                 }
               }
             });
         
             const themeColorMetaTag = document.querySelector('meta[name="theme-color"]');
             if (themeColorMetaTag) {
               if (theme === 'dark') {
                 themeColorMetaTag.setAttribute('content', '#121212');
               } else {
                 themeColorMetaTag.setAttribute('content', '#ffffff');
               }
             }
         
             updateStatusBar(theme);
             localStorage.setItem("theme", theme);
           }
         
           function initializeTheme() {
             const savedTheme = localStorage.getItem("theme");
             const theme = savedTheme || detectSystemTheme();
             applyTheme(theme);
           }
         
           window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
             const theme = e.matches ? "dark" : "light";
             applyTheme(theme);
           });
         
           initializeTheme();
         });
         
         import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
         import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
         import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
         import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
         import { remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
// Add these lines INSIDE your script, next to other imports
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

// Initialize storage AFTER app is initialized

         const firebaseConfig = {
           apiKey: "AIzaSyAC49cgzmUZjqRM1akkEJmIOLz_NKBCC5k",
           authDomain: "adiasta-686e4.firebaseapp.com",
           databaseURL: "https://adiasta-686e4-default-rtdb.europe-west1.firebasedatabase.app",
           projectId: "adiasta-686e4",
           storageBucket: "adiasta-686e4.appspot.com",
           messagingSenderId: "822931467224",
           appId: "1:822931467224:web:46f81b5779491efe6260ad",
           measurementId: "G-68996BGLFE",
         };
         
const app = initializeApp(firebaseConfig);
const storage = getStorage(app);
const auth = getAuth();
const database = getDatabase();

         const authContainer = document.getElementById("auth");
         const roomSelection = document.getElementById("room-selection");
         const chatContainer = document.getElementById("chat");
         const loginButton = document.getElementById("login");
         const registerButton = document.getElementById("register");
         const joinRoomButton = document.getElementById("join-room");
         const createRoomButton = document.getElementById("create-room");
         const roomNameInput = document.getElementById("room-name");
         const authError = document.getElementById("auth-error");
         const roomError = document.getElementById("room-error");
         const messagesDiv = document.getElementById("message-list");
         const sendButton = document.getElementById("send-button");
         const messageInput = document.getElementById("message-input");
         const userList = document.getElementById("user-list");
         const goBackButton = document.getElementById("go-back");
         
         let currentRoom = null;
         let currentUsername = null;
         
         const savedUser = localStorage.getItem("loggedInUser");
         const logoutButton = document.createElement("button");
         logoutButton.textContent = "Logout";
         logoutButton.id = "logout-button";
         logoutButton.addEventListener("click", () => {
           signOut(auth).then(() => {
             localStorage.removeItem("loggedInUser");
             location.reload();
           });
         });
         
         function appendLogoutButton() {
           logoutButton.innerHTML = `<i class="fas fa-sign-out-alt"></i>`; 
           document.body.appendChild(logoutButton);
         }
         
         if (savedUser) {
           const { uid, username } = JSON.parse(savedUser);
           currentUsername = username;
           showRoomSelection();
           appendLogoutButton();
         }
         
         function displayError(element, message) {
           element.textContent = message;
           element.style.color = "red";
           setTimeout(() => (element.textContent = ""), 3000);
         }
         
         function showRoomSelection() {
           authContainer.style.display = "none";
           roomSelection.style.display = "block";
         }
         
         let lastMessageSender = null; 
         
         function showChat() {
         roomSelection.style.display = "none";
         chatContainer.style.display = "flex";
         const usersHeader = document.querySelector(".header h3");
         usersHeader.textContent = currentRoom;
         
         loadMessages(); 
         loadUsers(); 
         loadTypingIndicator(); 
         
         const typingRef = ref(database, `rooms/${currentRoom}/typing`);
         onValue(typingRef, (snapshot) => {
         const typingData = snapshot.val();
         const typingUsers = Object.keys(typingData).filter((username) => typingData[username] && username !== currentUsername);
         
         if (typingUsers.length === 0 && lastMessageSender === currentUsername) {
           window.scrollTo(0, document.body.scrollHeight);
         }
         });
         
         goBackButton.style.display = "inline-block";
         }
         
         loginButton.addEventListener("click", () => {
           const email = document.getElementById("email").value;
           const password = document.getElementById("password").value;
           signInWithEmailAndPassword(auth, email, password)
             .then((userCredential) => {
               const user = userCredential.user;
               currentUsername = user.email.split("@")[0];
               localStorage.setItem(
                 "loggedInUser",
                 JSON.stringify({ uid: user.uid, username: currentUsername })
               );
               showRoomSelection();
               appendLogoutButton();
             })
             .catch((error) => displayError(authError, error.message));
         });
         
         registerButton.addEventListener("click", () => {
           const email = document.getElementById("email").value;
           const password = document.getElementById("password").value;
           createUserWithEmailAndPassword(auth, email, password)
             .then((userCredential) => {
               const user = userCredential.user;
               currentUsername = user.email.split("@")[0];
               localStorage.setItem(
                 "loggedInUser",
                 JSON.stringify({ uid: user.uid, username: currentUsername })
               );
               showRoomSelection();
               appendLogoutButton();
             })
             .catch((error) => displayError(authError, error.message));
         });
         
         function joinOrCreateRoom(action) {
           const roomName = roomNameInput.value.trim();
           if (roomName) {
             currentRoom = roomName;
             const roomRef = ref(database, `rooms/${roomName}`);
             if (action === "create") {
               set(roomRef, { createdAt: Date.now() }).then(() => showChat());
             } else {
               onValue(roomRef, (snapshot) => {
                 if (snapshot.exists()) {
                   showChat();
                 } else {
                   displayError(roomError, "Room does not exist. Try creating it.");
                 }
               });
             }
           } else {
             displayError(roomError, "Room name cannot be empty.");
           }
         }
         
         joinRoomButton.addEventListener("click", () => joinOrCreateRoom("join"));
         createRoomButton.addEventListener("click", () => joinOrCreateRoom("create"));
         
function loadMessages() {
  const messagesRef = ref(database, `rooms/${currentRoom}/messages`);
  messagesDiv.innerHTML = "";  // Clear the existing messages

  onValue(messagesRef, (snapshot) => {
    const messages = snapshot.val();
    if (messages) {
      for (let id in messages) {
        const message = messages[id];
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(message.username === currentUsername ? "sent" : "received");
        messageDiv.id = `message-${id}`;

        const userName = document.createElement("strong");
        userName.textContent = `${message.username}: `;

        const messageText = document.createElement("span");
        if (message.text) {
          messageText.textContent = message.text;
        } else if (message.fileURL) {
          const img = document.createElement("img");
          img.src = message.fileURL;
          img.style.maxWidth = "200px";
          img.style.maxHeight = "200px";
          messageText.appendChild(img);
        } else if (message.audioURL) {
          const audioElement = document.createElement("audio");
          audioElement.src = message.audioURL;
          audioElement.controls = true;
          audioElement.style.maxWidth = "200px";
          messageText.appendChild(audioElement);
        }

        // Timestamp
        const timestampDiv = document.createElement("div");
        timestampDiv.style.fontSize = "0.8em";
        timestampDiv.style.color = "gray";
        timestampDiv.textContent = new Date(message.timestamp).toLocaleTimeString();

        messageDiv.appendChild(userName);
        messageDiv.appendChild(messageText);
        messageDiv.appendChild(timestampDiv);

        messagesDiv.appendChild(messageDiv);

        // Call the long press and triple-click function on the message div
        addLongPressMessageOptions(messageDiv);
      }

      if (lastMessageSender === currentUsername) {
        window.scrollTo(0, document.body.scrollHeight);
      }
    }
  });
}

         
         function loadUsers() {
           const usersRef = ref(database, `rooms/${currentRoom}/users`);
           onValue(usersRef, (snapshot) => {
             const users = snapshot.val();
             if (users) {
               userList.innerHTML = "";
               for (let username in users) {
                 if (username !== currentUsername) {
                   const userDiv = document.createElement("div");
                   userDiv.classList.add("user");
                   userDiv.textContent = username;
                   userList.appendChild(userDiv);
                 }
               }
             }
           });
         }
         
         sendButton.addEventListener("click", () => {
           const text = messageInput.value.trim();
           if (text) {
             push(ref(database, `rooms/${currentRoom}/messages`), {
               username: currentUsername,
               text: text,
               timestamp: Date.now(),
             });
             messageInput.value = "";
             loadMessages();
           }
         });
         
         goBackButton.addEventListener("click", () => {
           chatContainer.style.display = "none";
           roomSelection.style.display = "block";
           goBackButton.style.display = "none"; 
         });
         
         onAuthStateChanged(auth, (user) => {
           if (user) {
             currentUsername = user.email.split("@")[0];
             showRoomSelection();
             appendLogoutButton();
           } else {
             authContainer.style.display = "block";
             roomSelection.style.display = "none";
             chatContainer.style.display = "none";
             logoutButton.remove();
           }
         });
         
         messageInput.addEventListener("keypress", (event) => {
           if (event.key === "Enter") {
             event.preventDefault();
             sendButton.click();
           }
         });
         
         let typingTimeout;
         messageInput.addEventListener("input", () => {
           const typingRef = ref(database, `rooms/${currentRoom}/typing/${currentUsername}`);
           set(typingRef, true);
           clearTimeout(typingTimeout);
           typingTimeout = setTimeout(() => {
             set(typingRef, false);
           }, 2000);
         });
         
         function loadTypingIndicator() {
           const typingRef = ref(database, `rooms/${currentRoom}/typing`);
           onValue(typingRef, (snapshot) => {
             const typingData = snapshot.val();
             const typingUsers = Object.keys(typingData).filter((username) => typingData[username] && username !== currentUsername);
             if (typingUsers.length > 0) {
               const typingText = typingUsers.length === 1
                 ? `${typingUsers[0]} is typing...`
                 : `${typingUsers.join(", ")} are typing...`;
               document.getElementById("typing-indicator").textContent = typingText;
               document.getElementById("typing-indicator").style.display = "block";
             } else {
               document.getElementById("typing-indicator").style.display = "none";
             }
           });
         }
         
         
         function addLongPressMessageOptions() {
  const messages = document.querySelectorAll('.message');
  
  messages.forEach(message => {
    let pressTimer;
    let isLongPress = false;
    let clickCount = 0;
    let clickTimer;

    // Touch events for mobile long press
    message.addEventListener('touchstart', (e) => {
      pressTimer = setTimeout(() => {
        isLongPress = true;
        showMessageOptions(message);
      }, 500); // 500ms long press
    });

    message.addEventListener('touchend', () => {
      clearTimeout(pressTimer);
    });

    message.addEventListener('touchmove', () => {
      clearTimeout(pressTimer);
    });

    // Mouse events for desktop long press
    message.addEventListener('mousedown', (e) => {
      pressTimer = setTimeout(() => {
        isLongPress = true;
        showMessageOptions(message);
      }, 500);
    });

    message.addEventListener('mouseup', () => {
      clearTimeout(pressTimer);
    });

    message.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });

    // Triple-click support
    message.addEventListener('click', () => {
      clickCount++;
      
      // Clear previous timer if exists
      clearTimeout(clickTimer);
      
      // Set a new timer
      clickTimer = setTimeout(() => {
        // If 3 clicks within 300ms, show options
        if (clickCount === 3) {
          showMessageOptions(message);
        }
        // Reset click count
        clickCount = 0;
      }, 300);
    });
  });

  function showMessageOptions(message) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.classList.add('message-options-overlay');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    `;

    // Create options container
    const optionsContainer = document.createElement('div');
    optionsContainer.style.cssText = `
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    `;

    // Copy message option
    const copyButton = document.createElement('button');
    copyButton.textContent = 'Copy Message';
    copyButton.style.cssText = `
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background-color: #f0f0f0;
      border: none;
      border-radius: 5px;
    `;
    copyButton.addEventListener('click', () => {
      const messageToCopy = message.textContent;
      navigator.clipboard.writeText(messageToCopy);
      removeOverlay();
    });

    // Delete message option (only for own messages)
    const messageText = message.querySelector('span');
    if (messageText) {
      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'Delete Message';
      deleteButton.style.cssText = `
        display: block;
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 5px;
      `;
      deleteButton.addEventListener('click', () => {
        // Implement message deletion logic
        // This would typically involve removing from Firebase database
        const messageId = message.id.replace('message-', '');
        const messageRef = ref(database, `rooms/${currentRoom}/messages/${messageId}`);
        remove(messageRef);
        removeOverlay();
      });
      optionsContainer.appendChild(deleteButton);
    }

    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'Cancel';
    cancelButton.style.cssText = `
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background-color: #e0e0e0;
      border: none;
      border-radius: 5px;
    `;
    cancelButton.addEventListener('click', removeOverlay);

    optionsContainer.appendChild(copyButton);
    optionsContainer.appendChild(cancelButton);
    overlay.appendChild(optionsContainer);
    document.body.appendChild(overlay);

    // Remove overlay function
    function removeOverlay() {
      document.body.removeChild(overlay);
    }

    // Close overlay when clicking outside
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        removeOverlay();
      }
    });
  }
}
const voiceMessageButton = document.getElementById('voice-message-button');
const voiceIcon = voiceMessageButton.querySelector('.material-symbols-outlined');
let mediaRecorder;
let audioChunks = [];

voiceMessageButton.addEventListener('click', async () => {
  if (!mediaRecorder || mediaRecorder.state !== 'recording') {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.addEventListener('dataavailable', (event) => {
        audioChunks.push(event.data);
      });

      mediaRecorder.addEventListener('stop', () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        
        const storageReference = storageRef(storage, `voice_messages/${currentRoom}/${Date.now()}.webm`);
        uploadBytes(storageReference, audioBlob).then((snapshot) => {
          getDownloadURL(snapshot.ref).then((downloadURL) => {
            push(ref(database, `rooms/${currentRoom}/messages`), {
              username: currentUsername,
              audioURL: downloadURL,
              timestamp: Date.now(),
            });
          });
        });

        stream.getTracks().forEach(track => track.stop());
        voiceIcon.textContent = 'mic';
        voiceMessageButton.classList.remove('recording');
      });

      mediaRecorder.start();
      voiceIcon.textContent = 'stop';
      voiceMessageButton.classList.add('recording');
    } catch (error) {
      console.error('Error accessing microphone', error);
      alert('Microphone access denied or not available');
    }
  } else {
    mediaRecorder.stop();
  }
});
      </script>
   </body>
</html>
